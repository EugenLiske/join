<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: contacts/contacts.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: contacts/contacts.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// MF - contact.js

/**
 * Contact Management - Main Orchestration
 * Coordinates validation, UI updates, Firebase operations and navigation
 */

// ================== IMPORTS ==================
import { 
    PAGES, 
    STORAGE_KEYS
} from '../config.js';

import { 
    getFormData, 
    generateInitials 
} from './contacts_validation.js';

import { 
    updateFieldValidation, 
    updateAvatarPreview, 
    updateSaveButtonState,
    displayContactSuccess,
    displayContactDataInForm,
    clearFormInputs,
    updateButtonState,
    showOverlayMessage
} from './contacts_ui_helpers.js';

import { 
    checkEmailExists,
    checkEmailExistsForEdit,
    saveContactToFirebase,
    saveEditContactToFirebase,
    deleteContactFromFirebase,
    loadExistingContact
} from './contacts_firebase_api.js';

// ================== DOM ELEMENT CONSTANTS ==================
const NAME_INPUT = document.getElementById('name_input');
const EMAIL_INPUT = document.getElementById('email_input');
const PHONE_INPUT = document.getElementById('telephone_input');
const SAVE_BUTTON = document.getElementById('save_button');
const BUTTON_TEXT = document.getElementById('button_text');
const CONTACT_AVATAR = document.getElementById('contact_avatar');
const AVATAR_INITIALS = document.getElementById('avatar_initials');

const CONTENT_HEAD_NAME = document.getElementById('content_head_name');
const CONTACT_EMAIL_DISPLAY = document.getElementById('contact_email');
const CONTACT_PHONE_DISPLAY = document.getElementById('contact_phone');

// ================== ORCHESTRATION FUNCTIONS ==================

/**
 * Orchestrates complete form validation and UI updates
 * @returns {Object} Complete form validation results
 */
// function validateContactForm() {
//     const formData = getFormData();
    
//     updateFieldValidation(NAME_INPUT, formData.nameValidation);
//     updateFieldValidation(EMAIL_INPUT, formData.emailValidation);
//     updateFieldValidation(PHONE_INPUT, formData.phoneValidation);
    
//     updateAvatarPreview(formData.name);
//     updateSaveButtonState(formData.isValid);
    
//     return formData;
// }

// ================== NAVIGATION FUNCTIONS ==================

/**
 * Navigates to success page with contact data
 * @param {Object} contactData - Contact data to display on success page
 */
function navigateToSuccessPage(contactData) {
    localStorage.setItem(STORAGE_KEYS.LAST_SAVED_CONTACT, JSON.stringify(contactData));
    //window.location.href = PAGES.SUCCESS_PAGE;
}

/**
 * Navigates to edit page with contact ID
 * @param {number} contactId - ID of contact to edit
 */
function editContact(contactId) {
    localStorage.setItem(STORAGE_KEYS.CURRENT_EDIT_ID, contactId);
    window.location.href = PAGES.EDIT_CONTACT;
}

/**
 * Closes edit/add overlay and returns to previous page
 */
function closeEditContact() {
    localStorage.removeItem(STORAGE_KEYS.CURRENT_EDIT_ID);
    window.location.href = PAGES.MAIN_PAGE;
}

// ================== SUCCESS PAGE FUNCTIONS ==================

/**
 * Loads and displays contact data for success page
 */
function loadContactDataForSuccessPage() {
    const contactDataJSON = localStorage.getItem(STORAGE_KEYS.LAST_SAVED_CONTACT);
    
    if (contactDataJSON) {
        try {
            const contactData = JSON.parse(contactDataJSON);
            displayContactSuccess(contactData);
            setupClickOutsideToClose();
            
            // Toast nach 0,5 Sekunden anzeigen
            setTimeout(() => {
                showOverlayMessage('Contact successfully created!', 'success', 3000);
            }, 500);
            
        } catch (error) {
            console.error('Error parsing contact data:', error);
        }
    } else {
        console.error('No contact data found for success page');
    }
}


/**
 * Sets up click-outside for success page overlay
 */
function setupClickOutsideToClose() {
    document.addEventListener('click', function(event) {
        const overlayContent = document.querySelector('.content');
        
        if (overlayContent &amp;&amp; !overlayContent.contains(event.target)) {
            localStorage.removeItem(STORAGE_KEYS.LAST_SAVED_CONTACT);
            window.history.back();
        }
    });
}


// ================== EDIT FUNCTIONALITY ==================


/**
 * Handles errors when contact loading fails
 * @param {Error} error - The error that occurred
 */
function handleContactLoadError(error) {
    showOverlayMessage('Error loading contact data. Contact may have been deleted.', 'error', 2500);
    setTimeout(() => {
        window.history.back();
    }, 3000);
}

/**
 * Loads contact data for editing and populates form
 * @param {number} contactId - ID of contact to load for editing
 * @returns {Promise&lt;Object|null>} Contact data or null if error
 */
async function loadContactForEdit(contactId) {
    try {
        const contactData = await loadExistingContact(contactId);
        if (!contactData) {
            throw new Error('Contact not found');
        }
        
        displayContactDataInForm(contactData);
        validateContactForm();
        return contactData;
        
    } catch (error) {
        handleContactLoadError(error);
        return null;
    }
}

/**
 * Auto-loads contact data when edit page loads
 */
function loadContactDataForEditPage() {
    const contactId = localStorage.getItem(STORAGE_KEYS.CURRENT_EDIT_ID);
    
    if (contactId) {
        loadContactForEdit(parseInt(contactId));
    } else {
        showOverlayMessage('No contact ID found for edit page', 'error', 2500);
        setTimeout(() => {
            window.history.back();
        }, 3000);
    }
}

// ================== DELETE FUNCTIONALITY ==================

/**
 * Deletes contact from success page and navigates to add contact
 * @param {number} contactId - ID of contact to delete
 */
async function deleteContactFromSuccessPage(contactId) {
    try {        
        await deleteContactFromFirebase(parseInt(contactId));
        
        // Success-Toast anzeigen
        showOverlayMessage('Contact deleted successfully', 'success', 1800);
        
        // Navigation nach 1.8 Sekunden
        setTimeout(() => {
            localStorage.removeItem(STORAGE_KEYS.LAST_SAVED_CONTACT);
            window.location.href = PAGES.ADD_CONTACT;
        }, 2000);
        
    } catch (error) {
        console.error('Error deleting contact:', error);
        // Error-Toast ohne Auto-Navigation
        showOverlayMessage('Error deleting contact. Please try again.', 'error', 3000);
    }
}
/**
 * Deletes contact from edit page and navigates back
 */
async function deleteContact() {
    const contactId = localStorage.getItem(STORAGE_KEYS.CURRENT_EDIT_ID);
    
    if (!contactId) {
        console.error('No contact ID found for deletion');
        return;
    }
    
    try {
        // Kurzer Info-Toast während Löschvorgang
        showOverlayMessage('Deleting contact...', 'warning', 1000);
        
        await deleteContactFromFirebase(parseInt(contactId));
        
        // Success-Toast anzeigen
        showOverlayMessage('Contact deleted successfully', 'success', 1500);
        
        // Navigation nach 1.8 Sekunden
        setTimeout(() => {
            localStorage.removeItem(STORAGE_KEYS.CURRENT_EDIT_ID);        
            window.history.back();
        }, 1800);
        
    } catch (error) {
        // Error-Toast ohne Auto-Navigation (Benutzer soll Fehler sehen)
        showOverlayMessage('Error deleting contact. Please try again.', 'error', 3000);
    }
}

// ================== MAIN SAVE FUNCTION ==================

/**
 * Main save function - handles both CREATE and UPDATE operations
 * @param {Event} event - Form submit event
 */
/**
 * Handles CREATE mode - saves new contact
 * @param {Object} formData - Validated form data
 * @returns {Promise&lt;boolean>} Success status
 */
async function handleCreateMode(formData) {
    const emailExists = await checkEmailExists(formData.email);
    if (emailExists) {
        showOverlayMessage('This email address is already in use. Please use a different email.', 'error', 3000);
        return false;
    }
    
    const savedContact = await saveContactToFirebase(formData.contactData);
    
    // Success-Toast anzeigen
    showOverlayMessage('Contact saved successfully', 'success', 1500);
    
    clearFormInputs();
    
    // Navigation zur Success-Page nach 1.8 Sekunden
    setTimeout(() => {
        navigateToSuccessPage(savedContact);
    }, 1800);
    
    return true;
}

/**
 * Handles EDIT mode - updates existing contact
 * @param {Object} formData - Validated form data
 * @param {string} contactId - ID of contact being edited
 * @returns {Promise&lt;boolean>} Success status
 */
async function handleEditMode(formData, contactId) {
    if (!contactId) {
        throw new Error('No contact ID found for editing');
    }
    
    const existingContact = await loadExistingContact(parseInt(contactId));
    if (!existingContact) {
        throw new Error('Could not load existing contact');
    }
    
    const emailChanged = hasEmailChanged(formData.email, existingContact.email);
    
    if (emailChanged) {
        const isDuplicate = await checkForDuplicateEmail(formData.email, contactId);
        if (isDuplicate) return false;
    }
    
    await saveEditContactToFirebase(parseInt(contactId), formData.contactData);
    showOverlayMessage('Contact updated successfully', 'success', 1500);
    
    return true;
}

function hasEmailChanged(newEmail, existingEmail) {
    return newEmail.toLowerCase() !== existingEmail.toLowerCase();
}

async function checkForDuplicateEmail(email, currentContactId) {
    const emailExists = await checkEmailExistsForEdit(email, parseInt(currentContactId));
    
    if (emailExists) {
        showOverlayMessage('This email address is already in use. Please use a different email.', 'error', 3000);
        return true;
    }
    
    return false;
}


/**
 * Main save function - coordinates CREATE/EDIT operations
 * @param {Event} event - Form submit event
 */
async function saveContact(event) {
    if (event) event.preventDefault();
    
    const formData = getFormData();
    if (!formData.isValid) {
        showOverlayMessage('Please correct the form errors before saving.');
        return false;
    }
    
    const contactId = localStorage.getItem(STORAGE_KEYS.CURRENT_EDIT_ID);
    const isEditMode = contactId !== null;
    
    return await executeSave(formData, isEditMode, contactId);
}

async function executeSave(formData, isEditMode, contactId) {
    try {
        const success = isEditMode 
            ? await handleEditMode(formData, contactId)
            : await handleCreateMode(formData);
        
        return success;
    } catch (error) {
        showOverlayMessage('Error saving contact. Please check your connection and try again.');
        return false;
    }
}

//Debugg
function validateContactForm() {
    const formData = getFormData();
    
    updateFieldValidation(NAME_INPUT, formData.nameValidation);
    updateFieldValidation(EMAIL_INPUT, formData.emailValidation);
    updateFieldValidation(PHONE_INPUT, formData.phoneValidation);
    
    updateAvatarPreview(formData.name);
    updateSaveButtonState(formData.isValid);
    
    return formData;
}

// ================== EVENT LISTENERS ==================

/**
 * Initializes form input event listeners
 */
function initializeEventListeners() {
    if (NAME_INPUT) NAME_INPUT.addEventListener('input', validateContactForm);
    if (EMAIL_INPUT) EMAIL_INPUT.addEventListener('input', validateContactForm);
    if (PHONE_INPUT) PHONE_INPUT.addEventListener('input', validateContactForm);
}

// ================== INITIALIZATION ==================

document.addEventListener('DOMContentLoaded', function() {

    if (window.location.pathname.includes('contacts_add_successful.html')) {
        loadContactDataForSuccessPage();
    } 
    else if (window.location.pathname.includes('contacts_edit.html')) {
        initializeEventListeners();
        loadContactDataForEditPage();
    }
    else {
        initializeEventListeners();
        
        if (NAME_INPUT || EMAIL_INPUT || PHONE_INPUT) {
            validateContactForm();
        }
    }
});

// ================== GLOBAL EXPORTS ==================
window.validateContactForm = validateContactForm;
window.closeEditContact = closeEditContact;
window.saveContact = saveContact;
window.clearFormInputs = clearFormInputs;
window.editContact = editContact;
window.deleteContact = deleteContact;
window.deleteContactFromSuccessPage = deleteContactFromSuccessPage;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#BASE_URL">BASE_URL</a></li><li><a href="global.html#assignRandomAvatarColor">assignRandomAvatarColor</a></li><li><a href="global.html#checkCategory">checkCategory</a></li><li><a href="global.html#checkCategorySelection">checkCategorySelection</a></li><li><a href="global.html#checkDate">checkDate</a></li><li><a href="global.html#checkDateFormat">checkDateFormat</a></li><li><a href="global.html#checkDuedate">checkDuedate</a></li><li><a href="global.html#checkEmailExists">checkEmailExists</a></li><li><a href="global.html#checkEmailExistsForEdit">checkEmailExistsForEdit</a></li><li><a href="global.html#checkIfOldSubtaskExists">checkIfOldSubtaskExists</a></li><li><a href="global.html#checkLoginEnable">checkLoginEnable</a></li><li><a href="global.html#checkNumberInterval">checkNumberInterval</a></li><li><a href="global.html#checkRequiredFields">checkRequiredFields</a></li><li><a href="global.html#checkRequiredFieldsToEnableButton">checkRequiredFieldsToEnableButton</a></li><li><a href="global.html#checkSingleUserMatch">checkSingleUserMatch</a></li><li><a href="global.html#checkTitle">checkTitle</a></li><li><a href="global.html#clearFormInputs">clearFormInputs</a></li><li><a href="global.html#clearPriorityButtons">clearPriorityButtons</a></li><li><a href="global.html#closeEditContact">closeEditContact</a></li><li><a href="global.html#closeMobileActionMenu">closeMobileActionMenu</a></li><li><a href="global.html#createContactDropDownSearchList">createContactDropDownSearchList</a></li><li><a href="global.html#createContactDropDownSearchListElement">createContactDropDownSearchListElement</a></li><li><a href="global.html#createContactElement">createContactElement</a></li><li><a href="global.html#createSuccessOverlayLogin">createSuccessOverlayLogin</a></li><li><a href="global.html#createTask">createTask</a></li><li><a href="global.html#dateValidation">dateValidation</a></li><li><a href="global.html#deleteContact">deleteContact</a></li><li><a href="global.html#deleteContactFromFirebase">deleteContactFromFirebase</a></li><li><a href="global.html#deleteContactFromSuccessPage">deleteContactFromSuccessPage</a></li><li><a href="global.html#deleteSelectedContact">deleteSelectedContact</a></li><li><a href="global.html#displayContactDataInForm">displayContactDataInForm</a></li><li><a href="global.html#displayContactDetails">displayContactDetails</a></li><li><a href="global.html#displayContactsList">displayContactsList</a></li><li><a href="global.html#editContact">editContact</a></li><li><a href="global.html#editSelectedContact">editSelectedContact</a></li><li><a href="global.html#emailInput">emailInput</a></li><li><a href="global.html#extractSubtaskNrFromId">extractSubtaskNrFromId</a></li><li><a href="global.html#findMatchingUser">findMatchingUser</a></li><li><a href="global.html#generateInitials">generateInitials</a></li><li><a href="global.html#getAllUsers">getAllUsers</a></li><li><a href="global.html#getAssignedPersons">getAssignedPersons</a></li><li><a href="global.html#getCheckbox">getCheckbox</a></li><li><a href="global.html#getCheckboxImg">getCheckboxImg</a></li><li><a href="global.html#getContactNameSearchIndices">getContactNameSearchIndices</a></li><li><a href="global.html#getCurrentPriority">getCurrentPriority</a></li><li><a href="global.html#getDateWarning">getDateWarning</a></li><li><a href="global.html#getDescription">getDescription</a></li><li><a href="global.html#getDuedate">getDuedate</a></li><li><a href="global.html#getFirstThreeAssignments">getFirstThreeAssignments</a></li><li><a href="global.html#getFormData">getFormData</a></li><li><a href="global.html#getNextContactId">getNextContactId</a></li><li><a href="global.html#getProgressbarTemplate">getProgressbarTemplate</a></li><li><a href="global.html#getSingleSubtask">getSingleSubtask</a></li><li><a href="global.html#getSubtaskTxt">getSubtaskTxt</a></li><li><a href="global.html#getSubtasks">getSubtasks</a></li><li><a href="global.html#getTitle">getTitle</a></li><li><a href="global.html#groupContactsByLetter">groupContactsByLetter</a></li><li><a href="global.html#handleContactLoadError">handleContactLoadError</a></li><li><a href="global.html#handleCreateMode">handleCreateMode</a></li><li><a href="global.html#handleEditMode">handleEditMode</a></li><li><a href="global.html#handleLoginPasswordInput">handleLoginPasswordInput</a></li><li><a href="global.html#hideSelectionList">hideSelectionList</a></li><li><a href="global.html#initAddTaskOverlay">initAddTaskOverlay</a></li><li><a href="global.html#initAddTaskPage">initAddTaskPage</a></li><li><a href="global.html#initAssignedPersons">initAssignedPersons</a></li><li><a href="global.html#initContactSearchList">initContactSearchList</a></li><li><a href="global.html#initLoginAutoFill">initLoginAutoFill</a></li><li><a href="global.html#initTaskForm">initTaskForm</a></li><li><a href="global.html#initializeEventListeners">initializeEventListeners</a></li><li><a href="global.html#initializeMobileResizeHandler">initializeMobileResizeHandler</a></li><li><a href="global.html#isDateInFuture">isDateInFuture</a></li><li><a href="global.html#isEmailValid">isEmailValid</a></li><li><a href="global.html#isLeapYear">isLeapYear</a></li><li><a href="global.html#loadAllContacts">loadAllContacts</a></li><li><a href="global.html#loadContactDataForEditPage">loadContactDataForEditPage</a></li><li><a href="global.html#loadContactDataForSuccessPage">loadContactDataForSuccessPage</a></li><li><a href="global.html#loadContactForEdit">loadContactForEdit</a></li><li><a href="global.html#loadContactScripts">loadContactScripts</a></li><li><a href="global.html#loadExistingContact">loadExistingContact</a></li><li><a href="global.html#loginButton">loginButton</a></li><li><a href="global.html#loginErrorContainer">loginErrorContainer</a></li><li><a href="global.html#loginGuest">loginGuest</a></li><li><a href="global.html#loginPwdIcon">loginPwdIcon</a></li><li><a href="global.html#loginUser">loginUser</a></li><li><a href="global.html#navigateToSuccessPage">navigateToSuccessPage</a></li><li><a href="global.html#openAddContactOverlay">openAddContactOverlay</a></li><li><a href="global.html#openMobileActionMenu">openMobileActionMenu</a></li><li><a href="global.html#overlayMessage">overlayMessage</a></li><li><a href="global.html#passwordIcon">passwordIcon</a></li><li><a href="global.html#passwordInput">passwordInput</a></li><li><a href="global.html#passwordInputField">passwordInputField</a></li><li><a href="global.html#removeDarkFixedLogoAfterAnimation">removeDarkFixedLogoAfterAnimation</a></li><li><a href="global.html#removeLightLogoAfterSplash">removeLightLogoAfterSplash</a></li><li><a href="global.html#removeOrAddWarning">removeOrAddWarning</a></li><li><a href="global.html#renderPersonIconsList">renderPersonIconsList</a></li><li><a href="global.html#resetExistingLoginError">resetExistingLoginError</a></li><li><a href="global.html#saveContact">saveContact</a></li><li><a href="global.html#saveContactToFirebase">saveContactToFirebase</a></li><li><a href="global.html#saveEditContactToFirebase">saveEditContactToFirebase</a></li><li><a href="global.html#selectContact">selectContact</a></li><li><a href="global.html#selectContactById">selectContactById</a></li><li><a href="global.html#selectPerson">selectPerson</a></li><li><a href="global.html#setAllButtonInactive">setAllButtonInactive</a></li><li><a href="global.html#setCurrentUserData">setCurrentUserData</a></li><li><a href="global.html#setDefaultIconPriority">setDefaultIconPriority</a></li><li><a href="global.html#setIconPriority">setIconPriority</a></li><li><a href="global.html#setPriorityButtonDefault">setPriorityButtonDefault</a></li><li><a href="global.html#setupClickOutsideToClose">setupClickOutsideToClose</a></li><li><a href="global.html#showCategorySelection">showCategorySelection</a></li><li><a href="global.html#showEmptyState">showEmptyState</a></li><li><a href="global.html#showErrorState">showErrorState</a></li><li><a href="global.html#showGenericLoginError">showGenericLoginError</a></li><li><a href="global.html#showLoadingState">showLoadingState</a></li><li><a href="global.html#showLoginErrorAndStop">showLoginErrorAndStop</a></li><li><a href="global.html#showMobileContactList">showMobileContactList</a></li><li><a href="global.html#showOverlayMessage">showOverlayMessage</a></li><li><a href="global.html#showStaticLogoAfterAnimation">showStaticLogoAfterAnimation</a></li><li><a href="global.html#showToastMessage">showToastMessage</a></li><li><a href="global.html#signupOverlay">signupOverlay</a></li><li><a href="global.html#simpleCheckDuedate">simpleCheckDuedate</a></li><li><a href="global.html#smoothLogoHandover">smoothLogoHandover</a></li><li><a href="global.html#storeUserInitials">storeUserInitials</a></li><li><a href="global.html#toggleCheckbox">toggleCheckbox</a></li><li><a href="global.html#toggleDropDownIcon">toggleDropDownIcon</a></li><li><a href="global.html#toggleDropDownSelection">toggleDropDownSelection</a></li><li><a href="global.html#toggleInputErrorDesign">toggleInputErrorDesign</a></li><li><a href="global.html#toggleLoginVisibility">toggleLoginVisibility</a></li><li><a href="global.html#toggleMobileActionMenu">toggleMobileActionMenu</a></li><li><a href="global.html#togglePriorityButtons">togglePriorityButtons</a></li><li><a href="global.html#toggleWarning">toggleWarning</a></li><li><a href="global.html#updateAvatarPreview">updateAvatarPreview</a></li><li><a href="global.html#updateButtonState">updateButtonState</a></li><li><a href="global.html#updateFieldValidation">updateFieldValidation</a></li><li><a href="global.html#updateSaveButtonState">updateSaveButtonState</a></li><li><a href="global.html#validateContactForm">validateContactForm</a></li><li><a href="global.html#validateEmail">validateEmail</a></li><li><a href="global.html#validateName">validateName</a></li><li><a href="global.html#validatePhone">validatePhone</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Oct 06 2025 14:22:22 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
