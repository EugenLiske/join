<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: contacts/contacts_firebase_api.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: contacts/contacts_firebase_api.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// MF contact_firebase_api.js

/**
 * Contacts Firebase API Module
 * All Firebase database operations for contact management
 */

import { 
    FIREBASE_URL, 
    AVATAR_COLORS, 
    FIREBASE_PATHS,
    DEFAULTS
} from '../config.js';

/**
 * Retrieves and increments the contact counter for new contact IDs
 * @returns {Promise&lt;number>} Next available contact ID
 */
export async function getNextContactId() {
    try {
        const counterUrl = `${FIREBASE_URL}${FIREBASE_PATHS.COUNTER}`;
        
        const response = await fetch(counterUrl);
        let currentCounter = DEFAULTS.START_COUNTER;
        
        if (response.ok) {
            const data = await response.json();
            currentCounter = data || DEFAULTS.START_COUNTER;
        }
        
        const nextId = currentCounter + 1;
        
        await fetch(counterUrl, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(nextId)
        });
        
        return nextId;
        
    } catch (error) {
        console.error('Error getting next contact ID:', error);
        return Date.now();
    }
}

/**
 * Checks if an email address already exists in the database
 * @param {string} email - Email address to check
 * @returns {Promise&lt;boolean>} True if email exists
 */
export async function checkEmailExists(email) {
    try {
        const contactsUrl = `${FIREBASE_URL}${FIREBASE_PATHS.CONTACTS_DATA}`;
        const response = await fetch(contactsUrl);
        
        if (!response.ok) return false;
        
        const contacts = await response.json();
        if (!contacts) return false;
        
        const emailLower = email.toLowerCase();
        
        for (const contact of Object.values(contacts)) {
            if (contact &amp;&amp; contact.email &amp;&amp; contact.email.toLowerCase() === emailLower) {
                return true;
            }
        }
        
        return false;
        
    } catch (error) {
        console.error('Error checking email existence:', error);
        return false;
    }
}

/**
 * Checks if an email exists for edit mode (excludes current contact's email)
 * @param {string} email - Email address to check
 * @param {number} currentContactId - ID of contact being edited to exclude from check
 * @returns {Promise&lt;boolean>} True if email exists in another contact
 */
// 

export async function checkEmailExistsForEdit(email, currentContactId) {
    try {
        const contactsUrl = `${FIREBASE_URL}${FIREBASE_PATHS.CONTACTS_DATA}`;
        const response = await fetch(contactsUrl);
        
        if (!response.ok) return false;
        
        const contacts = await response.json();
        if (!contacts) return false;
        
        const emailLower = email.toLowerCase();
        
        // Konvertiere currentContactId zu Number für sichere Vergleiche
        const currentId = parseInt(currentContactId);
        
        for (const contact of Object.values(contacts)) {
            if (contact &amp;&amp; contact.email &amp;&amp; contact.email.toLowerCase() === emailLower) {
                // Wenn die E-Mail zum aktuellen Kontakt gehört → erlauben (return false)
                if (parseInt(contact.id) === currentId) {
                    return false;
                }
                return true;
            }
        }
        
        // E-Mail existiert nirgends → erlauben
        return false;
        
    } catch (error) {
        return false;
    }
}

/**
 * Assigns a random avatar color from predefined palette
 * @returns {string} CSS variable for avatar background color
 */
export function assignRandomAvatarColor() {
    const randomIndex = Math.floor(Math.random() * AVATAR_COLORS.length);
    return AVATAR_COLORS[randomIndex];
}

/**
 * Loads existing contact data from Firebase
 * @param {number} contactId - ID of contact to load
 * @returns {Promise&lt;Object|null>} Contact data object or null if not found
 */
export async function loadExistingContact(contactId) {
    try {
        const contactUrl = `${FIREBASE_URL}${FIREBASE_PATHS.SINGLE_CONTACT(contactId)}`;
        const response = await fetch(contactUrl);
        
        if (!response.ok) {
            throw new Error(`Failed to load contact: ${response.statusText}`);
        }
        
        const contactData = await response.json();
        return contactData;
        
    } catch (error) {
        return null;
    }
}

/**
 * Saves a new contact to Firebase with auto-generated ID and metadata
 * @param {Object} contactData - Contact data (name, email, phone)
 * @returns {Promise&lt;Object>} Complete contact object with metadata
 */
export async function saveContactToFirebase(contactData) {
    const contactId = await getNextContactId();
    
    const contactWithMetadata = {
        ...contactData,
        id: contactId,
        avatarColor: assignRandomAvatarColor(),
        createdAt: new Date().toISOString()
    };
    
    const contactUrl = `${FIREBASE_URL}${FIREBASE_PATHS.SINGLE_CONTACT(contactId)}`;
    const response = await fetch(contactUrl, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(contactWithMetadata)
    });
    
    if (!response.ok) {
        throw new Error(`Failed to save contact: ${response.statusText}`);
    }
    return contactWithMetadata;
}

/**
 * Updates existing contact in Firebase without changing ID or counter
 * @param {number} contactId - ID of contact to update
 * @param {Object} contactData - Updated contact data (name, email, phone)
 * @returns {Promise&lt;Object>} Updated contact object with preserved metadata
 */
export async function saveEditContactToFirebase(contactId, contactData) {
    try {
        // Get existing contact to preserve metadata
        const existingContact = await loadExistingContact(contactId);
        if (!existingContact) {
            throw new Error('Contact not found for editing');
        }
        
        const updatedContact = {
            ...existingContact,           // Preserve id, avatarColor, createdAt
            ...contactData,               // Update name, email, phone
            updatedAt: new Date().toISOString()
        };
        
        const contactUrl = `${FIREBASE_URL}${FIREBASE_PATHS.SINGLE_CONTACT(contactId)}`;
        const response = await fetch(contactUrl, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedContact)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update contact: ${response.statusText}`);
        }
        return updatedContact;
        
    } catch (error) {
        console.error('Error updating contact:', error);
        throw error;
    }
}

/**
 * Deletes contact from Firebase without affecting counter
 * @param {number} contactId - ID of contact to delete
 * @returns {Promise&lt;boolean>} True if deletion successful
 */
export async function deleteContactFromFirebase(contactId) {
    try {
        const contactUrl = `${FIREBASE_URL}${FIREBASE_PATHS.SINGLE_CONTACT(contactId)}`;
        const response = await fetch(contactUrl, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`Failed to delete contact: ${response.statusText}`);
        }
        return true;
        
    } catch (error) {
        throw error;
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#BASE_URL">BASE_URL</a></li><li><a href="global.html#assignRandomAvatarColor">assignRandomAvatarColor</a></li><li><a href="global.html#checkCategory">checkCategory</a></li><li><a href="global.html#checkCategorySelection">checkCategorySelection</a></li><li><a href="global.html#checkDate">checkDate</a></li><li><a href="global.html#checkDateFormat">checkDateFormat</a></li><li><a href="global.html#checkDuedate">checkDuedate</a></li><li><a href="global.html#checkEmailExists">checkEmailExists</a></li><li><a href="global.html#checkEmailExistsForEdit">checkEmailExistsForEdit</a></li><li><a href="global.html#checkIfOldSubtaskExists">checkIfOldSubtaskExists</a></li><li><a href="global.html#checkLoginEnable">checkLoginEnable</a></li><li><a href="global.html#checkNumberInterval">checkNumberInterval</a></li><li><a href="global.html#checkRequiredFields">checkRequiredFields</a></li><li><a href="global.html#checkRequiredFieldsToEnableButton">checkRequiredFieldsToEnableButton</a></li><li><a href="global.html#checkSingleUserMatch">checkSingleUserMatch</a></li><li><a href="global.html#checkTitle">checkTitle</a></li><li><a href="global.html#clearFormInputs">clearFormInputs</a></li><li><a href="global.html#clearPriorityButtons">clearPriorityButtons</a></li><li><a href="global.html#closeEditContact">closeEditContact</a></li><li><a href="global.html#closeMobileActionMenu">closeMobileActionMenu</a></li><li><a href="global.html#createContactDropDownSearchList">createContactDropDownSearchList</a></li><li><a href="global.html#createContactDropDownSearchListElement">createContactDropDownSearchListElement</a></li><li><a href="global.html#createContactElement">createContactElement</a></li><li><a href="global.html#createSuccessOverlayLogin">createSuccessOverlayLogin</a></li><li><a href="global.html#createTask">createTask</a></li><li><a href="global.html#dateValidation">dateValidation</a></li><li><a href="global.html#deleteContact">deleteContact</a></li><li><a href="global.html#deleteContactFromFirebase">deleteContactFromFirebase</a></li><li><a href="global.html#deleteContactFromSuccessPage">deleteContactFromSuccessPage</a></li><li><a href="global.html#deleteSelectedContact">deleteSelectedContact</a></li><li><a href="global.html#displayContactDataInForm">displayContactDataInForm</a></li><li><a href="global.html#displayContactDetails">displayContactDetails</a></li><li><a href="global.html#displayContactsList">displayContactsList</a></li><li><a href="global.html#editContact">editContact</a></li><li><a href="global.html#editSelectedContact">editSelectedContact</a></li><li><a href="global.html#emailInput">emailInput</a></li><li><a href="global.html#extractSubtaskNrFromId">extractSubtaskNrFromId</a></li><li><a href="global.html#findMatchingUser">findMatchingUser</a></li><li><a href="global.html#generateInitials">generateInitials</a></li><li><a href="global.html#getAllUsers">getAllUsers</a></li><li><a href="global.html#getAssignedPersons">getAssignedPersons</a></li><li><a href="global.html#getCheckbox">getCheckbox</a></li><li><a href="global.html#getCheckboxImg">getCheckboxImg</a></li><li><a href="global.html#getContactNameSearchIndices">getContactNameSearchIndices</a></li><li><a href="global.html#getCurrentPriority">getCurrentPriority</a></li><li><a href="global.html#getDateWarning">getDateWarning</a></li><li><a href="global.html#getDescription">getDescription</a></li><li><a href="global.html#getDuedate">getDuedate</a></li><li><a href="global.html#getFirstThreeAssignments">getFirstThreeAssignments</a></li><li><a href="global.html#getFormData">getFormData</a></li><li><a href="global.html#getNextContactId">getNextContactId</a></li><li><a href="global.html#getProgressbarTemplate">getProgressbarTemplate</a></li><li><a href="global.html#getSingleSubtask">getSingleSubtask</a></li><li><a href="global.html#getSubtaskTxt">getSubtaskTxt</a></li><li><a href="global.html#getSubtasks">getSubtasks</a></li><li><a href="global.html#getTitle">getTitle</a></li><li><a href="global.html#groupContactsByLetter">groupContactsByLetter</a></li><li><a href="global.html#handleContactLoadError">handleContactLoadError</a></li><li><a href="global.html#handleCreateMode">handleCreateMode</a></li><li><a href="global.html#handleEditMode">handleEditMode</a></li><li><a href="global.html#handleLoginPasswordInput">handleLoginPasswordInput</a></li><li><a href="global.html#hideSelectionList">hideSelectionList</a></li><li><a href="global.html#initAddTaskOverlay">initAddTaskOverlay</a></li><li><a href="global.html#initAddTaskPage">initAddTaskPage</a></li><li><a href="global.html#initAssignedPersons">initAssignedPersons</a></li><li><a href="global.html#initContactSearchList">initContactSearchList</a></li><li><a href="global.html#initLoginAutoFill">initLoginAutoFill</a></li><li><a href="global.html#initTaskForm">initTaskForm</a></li><li><a href="global.html#initializeEventListeners">initializeEventListeners</a></li><li><a href="global.html#initializeMobileResizeHandler">initializeMobileResizeHandler</a></li><li><a href="global.html#isDateInFuture">isDateInFuture</a></li><li><a href="global.html#isEmailValid">isEmailValid</a></li><li><a href="global.html#isLeapYear">isLeapYear</a></li><li><a href="global.html#loadAllContacts">loadAllContacts</a></li><li><a href="global.html#loadContactDataForEditPage">loadContactDataForEditPage</a></li><li><a href="global.html#loadContactDataForSuccessPage">loadContactDataForSuccessPage</a></li><li><a href="global.html#loadContactForEdit">loadContactForEdit</a></li><li><a href="global.html#loadContactScripts">loadContactScripts</a></li><li><a href="global.html#loadExistingContact">loadExistingContact</a></li><li><a href="global.html#loginButton">loginButton</a></li><li><a href="global.html#loginErrorContainer">loginErrorContainer</a></li><li><a href="global.html#loginGuest">loginGuest</a></li><li><a href="global.html#loginPwdIcon">loginPwdIcon</a></li><li><a href="global.html#loginUser">loginUser</a></li><li><a href="global.html#navigateToSuccessPage">navigateToSuccessPage</a></li><li><a href="global.html#openAddContactOverlay">openAddContactOverlay</a></li><li><a href="global.html#openMobileActionMenu">openMobileActionMenu</a></li><li><a href="global.html#overlayMessage">overlayMessage</a></li><li><a href="global.html#passwordIcon">passwordIcon</a></li><li><a href="global.html#passwordInput">passwordInput</a></li><li><a href="global.html#passwordInputField">passwordInputField</a></li><li><a href="global.html#removeDarkFixedLogoAfterAnimation">removeDarkFixedLogoAfterAnimation</a></li><li><a href="global.html#removeLightLogoAfterSplash">removeLightLogoAfterSplash</a></li><li><a href="global.html#removeOrAddWarning">removeOrAddWarning</a></li><li><a href="global.html#renderPersonIconsList">renderPersonIconsList</a></li><li><a href="global.html#resetExistingLoginError">resetExistingLoginError</a></li><li><a href="global.html#saveContact">saveContact</a></li><li><a href="global.html#saveContactToFirebase">saveContactToFirebase</a></li><li><a href="global.html#saveEditContactToFirebase">saveEditContactToFirebase</a></li><li><a href="global.html#selectContact">selectContact</a></li><li><a href="global.html#selectContactById">selectContactById</a></li><li><a href="global.html#selectPerson">selectPerson</a></li><li><a href="global.html#setAllButtonInactive">setAllButtonInactive</a></li><li><a href="global.html#setCurrentUserData">setCurrentUserData</a></li><li><a href="global.html#setDefaultIconPriority">setDefaultIconPriority</a></li><li><a href="global.html#setIconPriority">setIconPriority</a></li><li><a href="global.html#setPriorityButtonDefault">setPriorityButtonDefault</a></li><li><a href="global.html#setupClickOutsideToClose">setupClickOutsideToClose</a></li><li><a href="global.html#showCategorySelection">showCategorySelection</a></li><li><a href="global.html#showEmptyState">showEmptyState</a></li><li><a href="global.html#showErrorState">showErrorState</a></li><li><a href="global.html#showGenericLoginError">showGenericLoginError</a></li><li><a href="global.html#showLoadingState">showLoadingState</a></li><li><a href="global.html#showLoginErrorAndStop">showLoginErrorAndStop</a></li><li><a href="global.html#showMobileContactList">showMobileContactList</a></li><li><a href="global.html#showOverlayMessage">showOverlayMessage</a></li><li><a href="global.html#showStaticLogoAfterAnimation">showStaticLogoAfterAnimation</a></li><li><a href="global.html#showToastMessage">showToastMessage</a></li><li><a href="global.html#signupOverlay">signupOverlay</a></li><li><a href="global.html#simpleCheckDuedate">simpleCheckDuedate</a></li><li><a href="global.html#smoothLogoHandover">smoothLogoHandover</a></li><li><a href="global.html#storeUserInitials">storeUserInitials</a></li><li><a href="global.html#toggleCheckbox">toggleCheckbox</a></li><li><a href="global.html#toggleDropDownIcon">toggleDropDownIcon</a></li><li><a href="global.html#toggleDropDownSelection">toggleDropDownSelection</a></li><li><a href="global.html#toggleInputErrorDesign">toggleInputErrorDesign</a></li><li><a href="global.html#toggleLoginVisibility">toggleLoginVisibility</a></li><li><a href="global.html#toggleMobileActionMenu">toggleMobileActionMenu</a></li><li><a href="global.html#togglePriorityButtons">togglePriorityButtons</a></li><li><a href="global.html#toggleWarning">toggleWarning</a></li><li><a href="global.html#updateAvatarPreview">updateAvatarPreview</a></li><li><a href="global.html#updateButtonState">updateButtonState</a></li><li><a href="global.html#updateFieldValidation">updateFieldValidation</a></li><li><a href="global.html#updateSaveButtonState">updateSaveButtonState</a></li><li><a href="global.html#validateContactForm">validateContactForm</a></li><li><a href="global.html#validateEmail">validateEmail</a></li><li><a href="global.html#validateName">validateName</a></li><li><a href="global.html#validatePhone">validatePhone</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Mon Oct 06 2025 14:22:22 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
